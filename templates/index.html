<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–î–∏—Ñ—Ä–∞–∫—Ü–∏—è —ç–ª–µ–∫—Ç—Ä–æ–Ω–æ–≤</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Segoe UI', Tahoma, sans-serif;
            background: linear-gradient(135deg, #0f0f23, #1a1a2e, #16213e);
            min-height: 100vh;
            color: #e0e0e0;
            padding: 20px;
        }

        .container { max-width: 1400px; margin: 0 auto; }

        h1 {
            text-align: center;
            color: #00d4ff;
            margin-bottom: 25px;
            font-size: 2em;
            text-shadow: 0 0 20px rgba(0, 212, 255, 0.5);
        }

        .main-layout {
            display: grid;
            grid-template-columns: 320px 1fr;
            gap: 25px;
        }

        .panel {
            background: rgba(26, 26, 46, 0.95);
            border-radius: 12px;
            padding: 20px;
            border: 1px solid rgba(0, 212, 255, 0.3);
        }

        .panel-title {
            color: #00d4ff;
            font-size: 1.2em;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid rgba(0, 212, 255, 0.3);
        }

        .form-group { margin-bottom: 18px; }

        label {
            display: block;
            margin-bottom: 6px;
            color: #b0b0b0;
            font-size: 0.9em;
        }

        input[type="number"], select {
            width: 100%;
            padding: 10px;
            border: 1px solid rgba(0, 212, 255, 0.3);
            border-radius: 6px;
            background: rgba(15, 15, 35, 0.9);
            color: #e0e0e0;
            font-size: 0.95em;
        }

        input[type="number"]:focus, select:focus {
            outline: none;
            border-color: #00d4ff;
        }

        input[type="range"] {
            width: 100%;
            height: 6px;
            -webkit-appearance: none;
            background: linear-gradient(90deg, #00d4ff, #ff6b6b);
            border-radius: 3px;
        }

        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 18px;
            height: 18px;
            background: #00d4ff;
            border-radius: 50%;
            cursor: pointer;
        }

        .input-row {
            display: flex;
            gap: 8px;
        }

        .input-row input { flex: 1; }
        .input-row select { width: 75px; flex-shrink: 0; }

        .btn-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
        }

        .btn {
            padding: 10px 6px;
            border: 2px solid rgba(0, 212, 255, 0.3);
            border-radius: 6px;
            background: transparent;
            color: #e0e0e0;
            cursor: pointer;
            font-size: 0.85em;
            transition: all 0.2s;
        }

        .btn:hover {
            border-color: #00d4ff;
            background: rgba(0, 212, 255, 0.1);
        }

        .btn.active {
            border-color: #00d4ff;
            background: rgba(0, 212, 255, 0.2);
            color: #00d4ff;
        }

        .simulate-btn {
            width: 100%;
            padding: 14px;
            background: linear-gradient(135deg, #00d4ff, #0099cc);
            border: none;
            border-radius: 8px;
            color: #0f0f23;
            font-size: 1.1em;
            font-weight: bold;
            cursor: pointer;
            margin-top: 15px;
        }

        .simulate-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0, 212, 255, 0.4);
        }

        .simulate-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .results {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .images-row {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
        }

        .image-box {
            text-align: center;
        }

        .image-box img {
            width: 100%;
            border-radius: 8px;
            border: 1px solid rgba(0, 212, 255, 0.2);
        }

        .image-box .label {
            margin-top: 8px;
            color: #888;
            font-size: 0.9em;
        }

        .info-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
        }

        .info-item {
            display: flex;
            justify-content: space-between;
            padding: 8px 12px;
            background: rgba(0, 212, 255, 0.1);
            border-radius: 6px;
        }

        .info-item .label { color: #888; }
        .info-item .value { color: #00d4ff; font-weight: bold; }

        .hidden { display: none !important; }

        .note {
            font-size: 0.8em;
            color: #666;
            margin-top: 4px;
            font-style: italic;
        }

        .divider {
            margin: 15px 0;
            border: none;
            border-top: 1px solid rgba(0, 212, 255, 0.2);
        }

        .section-title {
            color: #00d4ff;
            font-size: 0.95em;
            margin-bottom: 12px;
            opacity: 0.8;
        }

        .checkbox-row {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .checkbox-row input[type="checkbox"] {
            width: 18px;
            height: 18px;
            accent-color: #00d4ff;
        }

        .checkbox-row label { margin: 0; cursor: pointer; }

        .gamma-slider { display: none; margin-top: 10px; }
        .gamma-slider.active { display: block; }

        .loading {
            display: none;
            text-align: center;
            padding: 60px;
        }

        .loading.active { display: block; }

        .spinner {
            width: 50px;
            height: 50px;
            border: 4px solid rgba(0, 212, 255, 0.2);
            border-top-color: #00d4ff;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }

        @keyframes spin { to { transform: rotate(360deg); } }

        .placeholder {
            text-align: center;
            padding: 80px 20px;
            color: #555;
        }

        .placeholder-icon {
            font-size: 3.5em;
            color: #00d4ff;
            opacity: 0.4;
            margin-bottom: 15px;
        }

        /* –°–µ—Ç–∫–∞ –¥–ª—è —Ä–∏—Å–æ–≤–∞–Ω–∏—è */
        .grid-container { display: none; margin-top: 10px; }
        .grid-container.active { display: block; }

        .aperture-grid {
            display: grid;
            grid-template-columns: repeat(10, 1fr);
            gap: 2px;
            background: rgba(0, 212, 255, 0.2);
            padding: 2px;
            border-radius: 6px;
            max-width: 280px;
        }

        .grid-cell {
            aspect-ratio: 1;
            background: #1a1a2e;
            border: 1px solid rgba(0, 212, 255, 0.3);
            cursor: pointer;
            border-radius: 2px;
        }

        .grid-cell:hover { border-color: #00d4ff; }
        .grid-cell.active { background: #fff; }

        .grid-buttons {
            display: flex;
            gap: 8px;
            margin-top: 8px;
            max-width: 280px;
        }

        .grid-buttons button {
            flex: 1;
            padding: 6px;
            font-size: 0.8em;
        }

        /* –ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–∞–π–ª–∞ */
        .file-section { display: none; margin-top: 10px; }
        .file-section.active { display: block; }

        .file-label {
            display: block;
            padding: 12px;
            background: rgba(0, 212, 255, 0.1);
            border: 2px dashed rgba(0, 212, 255, 0.3);
            border-radius: 6px;
            text-align: center;
            cursor: pointer;
        }

        .file-label:hover {
            border-color: #00d4ff;
            background: rgba(0, 212, 255, 0.15);
        }

        .file-input { display: none; }

        @media (max-width: 1000px) {
            .main-layout { grid-template-columns: 1fr; }
            .images-row { grid-template-columns: 1fr; }
            .info-grid { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>
<div class="container">
    <h1>üî¨ –°–∏–º—É–ª—è—Ç–æ—Ä –¥–∏—Ñ—Ä–∞–∫—Ü–∏–∏ —ç–ª–µ–∫—Ç—Ä–æ–Ω–æ–≤</h1>

    <div class="main-layout">
        <!-- –ü–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è -->
        <div class="panel">
            <h2 class="panel-title">–ü–∞—Ä–∞–º–µ—Ç—Ä—ã</h2>

            <!-- –¢–∏–ø –∞–ø–µ—Ä—Ç—É—Ä—ã -->
            <div class="form-group">
                <label>–¢–∏–ø –∞–ø–µ—Ä—Ç—É—Ä—ã:</label>
                <div class="btn-grid" id="aperture-btns">
                    <button class="btn active" data-type="single">1 —â–µ–ª—å</button>
                    <button class="btn" data-type="double">2 —â–µ–ª–∏</button>
                    <button class="btn" data-type="triple">3 —â–µ–ª–∏</button>
                    <button class="btn" data-type="circle">–ö—Ä—É–≥</button>
                    <button class="btn" data-type="grid">–°–µ—Ç–∫–∞</button>
                    <button class="btn" data-type="image">–§–æ—Ç–æ</button>
                </div>
            </div>

            <!-- –ü–∞—Ä–∞–º–µ—Ç—Ä—ã —â–µ–ª–∏ -->
            <div class="form-group" id="slit-params">
                <label>–®–∏—Ä–∏–Ω–∞ —â–µ–ª–∏:</label>
                <div class="input-row">
                    <input type="number" id="slit-width" value="10" min="0.1" step="0.1">
                    <select id="slit-width-unit">
                        <option value="nm">–Ω–º</option>
                        <option value="um" selected>–º–∫–º</option>
                        <option value="mm">–º–º</option>
                    </select>
                </div>
            </div>

            <!-- –†–∞—Å—Å—Ç–æ—è–Ω–∏–µ –º–µ–∂–¥—É —â–µ–ª—è–º–∏ -->
            <div class="form-group hidden" id="separation-params">
                <label>–†–∞—Å—Å—Ç–æ—è–Ω–∏–µ –º–µ–∂–¥—É —â–µ–ª—è–º–∏:</label>
                <div class="input-row">
                    <input type="number" id="separation" value="25" min="0.1" step="0.1">
                    <select id="separation-unit">
                        <option value="nm">–Ω–º</option>
                        <option value="um" selected>–º–∫–º</option>
                        <option value="mm">–º–º</option>
                    </select>
                </div>
            </div>

            <!-- –†–∞–¥–∏—É—Å –∫—Ä—É–≥–∞ -->
            <div class="form-group hidden" id="circle-params">
                <label>–†–∞–¥–∏—É—Å –æ—Ç–≤–µ—Ä—Å—Ç–∏—è:</label>
                <div class="input-row">
                    <input type="number" id="radius" value="20" min="0.1" step="0.1">
                    <select id="radius-unit">
                        <option value="nm">–Ω–º</option>
                        <option value="um" selected>–º–∫–º</option>
                        <option value="mm">–º–º</option>
                    </select>
                </div>
            </div>

            <!-- –°–µ—Ç–∫–∞ –¥–ª—è —Ä–∏—Å–æ–≤–∞–Ω–∏—è -->
            <div class="grid-container" id="grid-section">
                <label>–ù–∞—Ä–∏—Å—É–π—Ç–µ –∞–ø–µ—Ä—Ç—É—Ä—É:</label>
                <div class="aperture-grid" id="aperture-grid"></div>
                <div class="grid-buttons">
                    <button class="btn" onclick="clearGrid()">–û—á–∏—Å—Ç–∏—Ç—å</button>
                    <button class="btn" onclick="fillGrid()">–ó–∞–ø–æ–ª–Ω–∏—Ç—å</button>
                    <button class="btn" onclick="invertGrid()">–ò–Ω–≤–µ—Ä—Å–∏—è</button>
                </div>
            </div>

            <!-- –ó–∞–≥—Ä—É–∑–∫–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è -->
            <div class="file-section" id="file-section">
                <label class="file-label" id="file-label">
                    –í—ã–±–µ—Ä–∏—Ç–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ (–±–µ–ª–æ–µ = —â–µ–ª—å)
                    <input type="file" class="file-input" id="file-input" accept="image/*">
                </label>
            </div>

            <hr class="divider">
            <div class="section-title">–§–∏–∑–∏—á–µ—Å–∫–∏–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã</div>

            <!-- –†–∞—Å—Å—Ç–æ—è–Ω–∏–µ –¥–æ —ç–∫—Ä–∞–Ω–∞ -->
            <div class="form-group">
                <label>–†–∞—Å—Å—Ç–æ—è–Ω–∏–µ –¥–æ —ç–∫—Ä–∞–Ω–∞:</label>
                <div class="input-row">
                    <input type="number" id="screen-distance" value="0.1" min="0" step="0.001">
                    <select id="distance-unit">
                        <option value="mm">–º–º</option>
                        <option value="cm">—Å–º</option>
                        <option value="m" selected>–º</option>
                    </select>
                </div>
                <div class="note">–ü—Ä–∏ z=0 –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è –∞–ø–µ—Ä—Ç—É—Ä–∞</div>
            </div>

            <!-- –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —ç–ª–µ–∫—Ç—Ä–æ–Ω–æ–≤ -->
            <div class="form-group">
                <label>–≠–ª–µ–∫—Ç—Ä–æ–Ω–æ–≤: <span id="electrons-val">10 000</span></label>
                <input type="range" id="num-electrons" min="100" max="100000" step="100" value="10000">
            </div>

            <!-- –†–∞–∑–º–µ—Ä —Å–µ—Ç–∫–∏ -->
            <div class="form-group">
                <label>–†–∞–∑—Ä–µ—à–µ–Ω–∏–µ:</label>
                <select id="grid-size">
                    <option value="128">128 √ó 128</option>
                    <option value="256" selected>256 √ó 256</option>
                    <option value="512">512 √ó 512</option>
                </select>
            </div>

            <hr class="divider">
            <div class="section-title">–û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ</div>

            <!-- –ì–∞–º–º–∞-–∫–æ—Ä—Ä–µ–∫—Ü–∏—è -->
            <div class="form-group">
                <div class="checkbox-row">
                    <input type="checkbox" id="gamma-enabled">
                    <label for="gamma-enabled">–ì–∞–º–º–∞-–∫–æ—Ä—Ä–µ–∫—Ü–∏—è (–∫–æ–Ω—Ç—Ä–∞—Å—Ç)</label>
                </div>
                <div class="gamma-slider" id="gamma-slider">
                    <label>–ì–∞–º–º–∞: <span id="gamma-val">0.30</span></label>
                    <input type="range" id="gamma" min="0.1" max="1.0" step="0.05" value="0.3">
                </div>
            </div>

            <button class="simulate-btn" id="simulate-btn">–ó–∞–ø—É—Å—Ç–∏—Ç—å —Å–∏–º—É–ª—è—Ü–∏—é</button>
        </div>

        <!-- –†–µ–∑—É–ª—å—Ç–∞—Ç—ã -->
        <div class="results">
            <div class="loading" id="loading">
                <div class="spinner"></div>
                <p>–í—ã—á–∏—Å–ª–µ–Ω–∏–µ...</p>
            </div>

            <div id="results-content">
                <div class="placeholder" id="placeholder">
                    <div class="placeholder-icon">„Ä∞Ô∏è</div>
                    <h3>–ù–∞—Å—Ç—Ä–æ–π—Ç–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –∏ –∑–∞–ø—É—Å—Ç–∏—Ç–µ —Å–∏–º—É–ª—è—Ü–∏—é</h3>
                </div>

                <div class="panel hidden" id="images-panel">
                    <h3 class="panel-title">–î–∏—Ñ—Ä–∞–∫—Ü–∏–æ–Ω–Ω—ã–µ –∫–∞—Ä—Ç–∏–Ω—ã</h3>
                    <div class="images-row">
                        <div class="image-box">
                            <img id="img-aperture" src="" alt="">
                            <div class="label">–ê–ø–µ—Ä—Ç—É—Ä–∞</div>
                        </div>
                        <div class="image-box">
                            <img id="img-fresnel" src="" alt="">
                            <div class="label">–§—Ä–µ–Ω–µ–ª—å (–±–ª–∏–∂–Ω—è—è –∑–æ–Ω–∞)</div>
                        </div>
                        <div class="image-box">
                            <img id="img-fraunhofer" src="" alt="">
                            <div class="label">–§—Ä–∞—É–Ω–≥–æ—Ñ–µ—Ä (–¥–∞–ª—å–Ω—è—è –∑–æ–Ω–∞)</div>
                        </div>
                    </div>
                </div>

                <div class="panel hidden" id="info-panel">
                    <h3 class="panel-title">–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è</h3>
                    <div class="info-grid">
                        <div class="info-item">
                            <span class="label">–î–ª–∏–Ω–∞ –≤–æ–ª–Ω—ã Œª:</span>
                            <span class="value" id="info-wavelength">-</span>
                        </div>
                        <div class="info-item">
                            <span class="label">–≠–Ω–µ—Ä–≥–∏—è —ç–ª–µ–∫—Ç—Ä–æ–Ω–∞:</span>
                            <span class="value" id="info-energy">-</span>
                        </div>
                        <div class="info-item">
                            <span class="label">–†–∞–∑–º–µ—Ä –ø–æ–ª—è:</span>
                            <span class="value" id="info-field">-</span>
                        </div>
                        <div class="info-item">
                            <span class="label">–ß–∏—Å–ª–æ –§—Ä–µ–Ω–µ–ª—è N<sub>F</sub>:</span>
                            <span class="value" id="info-fresnel">-</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    let currentType = 'single';
    let customImage = null;
    let gridState = Array(10).fill(null).map(() => Array(10).fill(0));

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å–µ—Ç–∫–∏
    function initGrid() {
        const grid = document.getElementById('aperture-grid');
        grid.innerHTML = '';
        for (let i = 0; i < 100; i++) {
            const cell = document.createElement('div');
            cell.className = 'grid-cell';
            cell.dataset.idx = i;
            cell.addEventListener('click', () => {
                const row = Math.floor(i / 10);
                const col = i % 10;
                gridState[row][col] = gridState[row][col] ? 0 : 1;
                cell.classList.toggle('active');
            });
            grid.appendChild(cell);
        }
    }

    function clearGrid() {
        gridState = Array(10).fill(null).map(() => Array(10).fill(0));
        document.querySelectorAll('.grid-cell').forEach(c => c.classList.remove('active'));
    }

    function fillGrid() {
        gridState = Array(10).fill(null).map(() => Array(10).fill(1));
        document.querySelectorAll('.grid-cell').forEach(c => c.classList.add('active'));
    }

    function invertGrid() {
        gridState = gridState.map(row => row.map(v => v ? 0 : 1));
        document.querySelectorAll('.grid-cell').forEach((c, i) => {
            const row = Math.floor(i / 10);
            const col = i % 10;
            c.classList.toggle('active', gridState[row][col] === 1);
        });
    }

    initGrid();

    // –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–Ω–æ–ø–æ–∫ –∞–ø–µ—Ä—Ç—É—Ä—ã
    document.querySelectorAll('#aperture-btns .btn').forEach(btn => {
        btn.addEventListener('click', () => {
            document.querySelectorAll('#aperture-btns .btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            currentType = btn.dataset.type;
            updateVisibility();
        });
    });

    function updateVisibility() {
        const isSlit = ['single', 'double', 'triple'].includes(currentType);
        const isMultiSlit = ['double', 'triple'].includes(currentType);

        document.getElementById('slit-params').classList.toggle('hidden', !isSlit);
        document.getElementById('separation-params').classList.toggle('hidden', !isMultiSlit);
        document.getElementById('circle-params').classList.toggle('hidden', currentType !== 'circle');
        document.getElementById('grid-section').classList.toggle('active', currentType === 'grid');
        document.getElementById('file-section').classList.toggle('active', currentType === 'image');
    }

    // –ì–∞–º–º–∞-—Å–ª–∞–π–¥–µ—Ä
    document.getElementById('gamma-enabled').addEventListener('change', function() {
        document.getElementById('gamma-slider').classList.toggle('active', this.checked);
    });

    // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∑–Ω–∞—á–µ–Ω–∏–π
    document.getElementById('num-electrons').addEventListener('input', function() {
        document.getElementById('electrons-val').textContent = parseInt(this.value).toLocaleString();
    });

    document.getElementById('gamma').addEventListener('input', function() {
        document.getElementById('gamma-val').textContent = parseFloat(this.value).toFixed(2);
    });

    // –ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–∞–π–ª–∞
    document.getElementById('file-input').addEventListener('change', function(e) {
        const file = e.target.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = (e) => {
                customImage = e.target.result;
                document.getElementById('file-label').textContent = '‚úì ' + file.name;
            };
            reader.readAsDataURL(file);
        }
    });

    // –°–∏–º—É–ª—è—Ü–∏—è
    document.getElementById('simulate-btn').addEventListener('click', async () => {
        const btn = document.getElementById('simulate-btn');
        const loading = document.getElementById('loading');
        const placeholder = document.getElementById('placeholder');

        btn.disabled = true;
        loading.classList.add('active');
        placeholder.classList.add('hidden');

        const data = {
            aperture_type: currentType,
            slit_width: parseFloat(document.getElementById('slit-width').value),
            slit_width_unit: document.getElementById('slit-width-unit').value,
            separation: parseFloat(document.getElementById('separation').value),
            separation_unit: document.getElementById('separation-unit').value,
            radius: parseFloat(document.getElementById('radius').value),
            radius_unit: document.getElementById('radius-unit').value,
            screen_distance: parseFloat(document.getElementById('screen-distance').value),
            distance_unit: document.getElementById('distance-unit').value,
            num_electrons: parseInt(document.getElementById('num-electrons').value),
            grid_size: parseInt(document.getElementById('grid-size').value),
            gamma_enabled: document.getElementById('gamma-enabled').checked,
            gamma: parseFloat(document.getElementById('gamma').value),
            custom_image: currentType === 'image' ? customImage : null,
            grid_data: currentType === 'grid' ? gridState : null
        };

        try {
            const response = await fetch('/simulate', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            });

            const result = await response.json();

            if (result.success) {
                document.getElementById('img-aperture').src = 'data:image/png;base64,' + result.aperture;
                document.getElementById('img-fresnel').src = 'data:image/png;base64,' + result.fresnel;
                document.getElementById('img-fraunhofer').src = 'data:image/png;base64,' + result.fraunhofer;

                document.getElementById('info-wavelength').textContent = result.wavelength_nm.toFixed(4) + ' –Ω–º';
                document.getElementById('info-energy').textContent = result.energy_eV + ' —ç–í';
                document.getElementById('info-field').textContent = result.field_size_um.toFixed(1) + ' –º–∫–º';
                document.getElementById('info-fresnel').textContent = result.fresnel_number;

                document.getElementById('images-panel').classList.remove('hidden');
                document.getElementById('info-panel').classList.remove('hidden');
            }
        } catch (error) {
            console.error('–û—à–∏–±–∫–∞:', error);
            alert('–û—à–∏–±–∫–∞ —Å–∏–º—É–ª—è—Ü–∏–∏');
        } finally {
            btn.disabled = false;
            loading.classList.remove('active');
        }
    });

    updateVisibility();
</script>
</body>
</html>